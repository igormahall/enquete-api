# üìä API Django ‚Äî Sistema de Enquetes

Backend **RESTful** para gerenciar enquetes de m√∫ltipla escolha.  
Constru√≠do com **Django¬†5** + **Django REST Framework** e banco **PostgreSQL**.

---

## ‚ú® Vis√£o Geral

| Item | Detalhe |
|------|---------|
| **Stack** | Python¬†3.12 ¬∑ Django¬†5 ¬∑ DRF¬†3 ¬∑ PostgreSQL |
| **Auth** | Token (DRF Simple¬†JWT)¬π |
| **Objetivo** | CRUD completo de enquetes, preven√ß√£o de voto duplicado, auditoria de votos |
| **Deploy** | Docker¬†Compose, Heroku / Render / Fly.io ou VPS |

> ¬π O exemplo padr√£o identifica o usu√°rio por `id_participante`, mas a base est√° pronta para JWT ou qualquer outro esquema de autentica√ß√£o.

---

## ‚öôÔ∏è Configura√ß√£o R√°pida (Dev)

```bash
# 1. Clone o reposit√≥rio e entre na pasta
git clone https://github.com/<seu-usuario>/enquete-api.git
cd enquete-api

# 2. Crie e ative o ambiente virtual
python -m venv .venv
.venv\Scripts\activate       # Windows
#source .venv/bin/activate   # macOS / Linux

# 3. Instale as depend√™ncias
pip install -r requirements.txt

# 4. Configure as vari√°veis de ambiente
# Copie o arquivo de exemplo. No Windows, use 'copy' em vez de 'cp'.
cp .env.example .env

# AGORA, ABRA O ARQUIVO '.env' E EDITE-O com sua SECRET_KEY e a URL do seu banco de dados.
# Para gerar uma nova SECRET_KEY, voc√™ pode usar o comando que est√° comentado dentro do .env.example

# 5. Execute as migra√ß√µes e crie um superusu√°rio
python manage.py migrate
python manage.py createsuperuser

# 6. Execute o servidor de desenvolvimento
python manage.py runserver
```

A API sobe em **http://127.0.0.1:8000/**.

A documenta√ß√£o interativa da API estar√° em **/api/swagger/**.

---

## üóÑÔ∏è Modelo de Dados ‚Äî Detalhado

A l√≥gica do sistema √© sustentada por tr√™s tabelas principais.  
Os modelos foram cuidadosamente normalizados para manter integridade, rastreabilidade e desempenho.

### 1. Enquete (`Poll`)

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | `BigAutoField` (PK) | Identificador √∫nico |
| `titulo` | `CharField(max_length=120)` | Pergunta exibida ao usu√°rio |
| `data_criacao` | `DateTimeField(auto_now_add=True)` | Timestamp de cria√ß√£o |
| `data_encerramento` | `DateTimeField(null=True, blank=True)` | Encerramento opcional |
| `status` | `CharField(choices=[('Aberta','Aberta'),('Fechada','Fechada')], default='Aberta')` | Estado atual |

**M√©todos de dom√≠nio**

* `is_aberta()`¬†‚Üí¬†`bool` ‚Äì retorna se a enquete ainda aceita votos  
* `total_votos` (property)¬†‚Üí¬†`int` ‚Äì soma dos votos computados em todas as op√ß√µes

---

### 2. Op√ß√£o (`Choice`)

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | `BigAutoField` (PK) | Identificador √∫nico |
| `enquete` | `ForeignKey('Poll', related_name='opcoes', on_delete=CASCADE)` | Enquete associada |
| `texto_opcao` | `CharField(max_length=100)` | Texto exibido no bot√£o de voto |
| `votos` | `PositiveIntegerField(default=0)` | Contador denormalizado (cache) |

**M√©todos auxiliares**

* `percentual` (property) ‚Äì calcula **votos desta op√ß√£o √∑ total da enquete √ó¬†100** com fallback 0¬†%

> O contador `votos` √© atualizado via `F()` expressions para evitar condi√ß√£o de corrida e reduzir agrega√ß√µes caras em alta escala.

---

### 3. Voto (`Vote`)

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | `BigAutoField` (PK) | Identificador |
| `id_participante` | `CharField(max_length=64)` | Identificador do usu√°rio/visitante |
| `enquete` | `ForeignKey('Poll', on_delete=CASCADE)` | Enquete votada |
| `opcao_escolhida` | `ForeignKey('Choice', on_delete=CASCADE)` | Op√ß√£o votada |
| `data_voto` | `DateTimeField(auto_now_add=True)` | Timestamp |

**Restri√ß√£o de unicidade**

```python
class Meta:
    constraints = [
        models.UniqueConstraint(
            fields=["enquete", "id_participante"],
            name="unique_vote_per_participant_per_poll",
        )
    ]
```
Garante **1¬†voto por participante** em cada enquete.

---

### üîó Relacionamentos & Fluxo

```
Poll 1 ‚îÄ‚îÄ< Choice 1 ‚îÄ‚îÄ< Vote
           ^                 |
           |-----------------|
```

1. **Uma** `Enquete` possui **v√°rias** `Op√ß√µes`.  
2. Ao votar, cria‚Äëse um objeto `Voto` apontando para a op√ß√£o escolhida.  
3. Caso a restri√ß√£o de unicidade dispare, retorna 409¬†Conflict.  
4. Ap√≥s salvar o voto, o campo `votos` da op√ß√£o √© incrementado de forma at√¥mica.

---

## üîå Endpoints REST

| Verbo + Rota | A√ß√£o | Descri√ß√£o |
|--------------|------|-----------|
| `GET /api/enquetes/` | Listar | Retorna apenas enquetes **Abertas** |
| `GET /api/enquetes/{id}/` | Detalhar | Inclui op√ß√µes + contagem de votos |
| `POST /api/enquetes/` | Criar | Cria enquete com op√ß√µes aninhadas |
| `POST /api/enquetes/{id}/votar/` | Votar | Registra voto √∫nico |

> Todas as respostas seguem o padr√£o `application/json` com camelCase no payload.

Exemplo ‚Äî **POST /api/enquetes/4/votar/**
```json
{
  "id_opcao": 2,
  "id_participante": "9bbfae66-762c-4a90-9f4c-87db9e"
}
```

Poss√≠veis respostas:

| C√≥digo | Significado |
|--------|-------------|
| **200** OK | Voto computado |
| **400** Bad Request | Op√ß√£o n√£o pertence √† enquete |
| **409** Conflict | Participante j√° votou |

---

## üöÄ Deploy em Produ√ß√£o

```bash
docker compose up --build -d
```

* Container `web` (Django + Gunicorn)  
* Container `db` (PostgreSQL)  
* `collectstatic` executado automaticamente  

Edite vari√°veis no `.env` para **`DJANGO_SECRET_KEY`**, **`ALLOWED_HOSTS`** e **`DATABASE_URL`**.

---

## ‚úÖ Testes

```bash
pytest -q
```
Cobertura m√≠nima garantida **‚â•¬†90¬†%**.

---

## ü§ù Contribuindo

1. **Fork** ‚Üí **branch** (`git checkout -b feature/xyz`)  
2. `pre-commit run --all-files`  
3. Abra um **Pull Request** descrevendo a motiva√ß√£o e o escopo

---

## üìú Licen√ßa

Distribu√≠do sob a licen√ßa **MIT** ‚Äî consulte `LICENSE` para detalhes.
